# API Документация: Система Электронных Очередей

Это RESTful API для управления электронными очередями. Документация описывает все доступные эндпоинты, их параметры, тела запросов и возможные ответы.

## Начало работы

### Локальный запуск
Для запуска проекта требуется **Docker** и **Docker Compose**.

1.  Создайте файл `configs/config.yml` со следующими настройками для Docker-окружения:
    ```yaml
    port : "8080"
    db:
      host: "db"
      port: "5432"
      dbname: "queue-db"
      username: "admin"
      password: "admin_pass"
      sslmode: "disable"
    ```
2.  Выполните команду в корневой папке проекта:
    ```bash
    docker-compose up --build
    ```
    Сервис будет доступен по адресу `http://localhost:8080`.

### Аутентификация
Большинство эндпоинтов требуют аутентификации с помощью JWT.
1.  Получите токен через эндпоинт `POST /auth/sign-in`.
2.  Для всех защищенных запросов передавайте токен в заголовке `Authorization`.

**Формат заголовка:**
```
Authorization: Bearer <ваш_jwt_токен>
```

---

## 1. Эндпоинты аутентификации (`/auth`)

### Регистрация нового пользователя
-   **URL**: `POST /auth/sign-up`
-   **Описание**: Создает нового пользователя в системе.
-   **Аутентификация**: Не требуется.
-   **Тело запроса**:
    ```json
    {
      "username": "Иван Иванов",
      "password": "supersecretpassword",
      "tg_nick": "ivan_ivanov_tg",
      "group": "ИУ5-51Б"
    }
    ```
-   **Успешный ответ (200 OK)**:
    ```json
    {
      "id": 1,
      "message": "successfully signed up"
    }
    ```
-   **Ответ в случае ошибки**:
    -   `400 Bad Request`: `{ "error": "all fields are required" }` - Не все поля были переданы.
    -   `500 Internal Server Error`: `{ "error": "UNIQUE constraint failed: users.tg_nick" }` - Пользователь с таким `tg_nick` уже существует.

### Вход в систему
-   **URL**: `POST /auth/sign-in`
-   **Описание**: Аутентифицирует пользователя и возвращает JWT токен.
-   **Аутентификация**: Не требуется.
-   **Тело запроса**:
    ```json
    {
      "tg_nick": "ivan_ivanov_tg",
      "password": "supersecretpassword"
    }
    ```
-   **Успешный ответ (200 OK)**:
    ```json
    {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    }
    ```
-   **Ответ в случае ошибки**:
    -   `401 Unauthorized`: `{ "error": "invalid password" }` - Неверный пароль или `tg_nick`.

---

## 2. Эндпоинты управления пользователями (`/api`)

### Получение профиля текущего пользователя
-   **URL**: `GET /api/profile`
-   **Описание**: Возвращает информацию о пользователе, которому принадлежит токен.
-   **Аутентификация**: Требуется.
-   **Тело запроса**: Нет.
-   **Успешный ответ (200 OK)**:
    ```json
    {
      "user": {
        "id": 1,
        "username": "Иван Иванов",
        "tg_nick": "ivan_ivanov_tg",
        "group_id": 101,
        "is_admin": false
      }
    }
    ```

### Обновление профиля пользователя
-   **URL**: `PUT /api/profile`
-   **Описание**: Обновляет данные текущего пользователя. Администратор может обновить данные любого пользователя, указав `id` в теле запроса.
-   **Аутентификация**: Требуется.
-   **Тело запроса**: (Можно передавать только те поля, которые нужно изменить)
    ```json
    {
      "username": "Иван Петров",
      "group_id": 102
    }
    ```
-   **Успешный ответ (200 OK)**:
    ```json
    { "message": "user updated successfully" }
    ```

---

## 3. Эндпоинты для администраторов (`/api/admin`)

### Получение списка всех пользователей
-   **URL**: `GET /api/admin/users`
-   **Описание**: Возвращает список всех пользователей системы.
-   **Аутентификация**: Требуются права администратора.
-   **Тело запроса**: Нет.
-   **Успешный ответ (200 OK)**:
    ```json
    {
      "users": [
        { "id": 1, "username": "Иван Иванов", "tg_nick": "ivan_ivanov_tg", "group_id": 101, "is_admin": false },
        { "id": 2, "username": "Админ Админов", "tg_nick": "admin_tg", "group_id": 1, "is_admin": true }
      ]
    }
    ```

### Удаление пользователя
-   **URL**: `DELETE /api/admin/users/:id`
-   **Описание**: Удаляет пользователя по его ID.
-   **Аутентификация**: Требуются права администратора.
-   **Параметры URL**:
    -   `id` (integer): ID пользователя для удаления.
-   **Тело запроса**: Нет.
-   **Успешный ответ (200 OK)**:
    ```json
    { "message": "user deleted successfully" }
    ```

---

## 4. Эндпоинты для работы с факультетами (`/api/faculties`)

### Получение списка всех факультетов
-   **URL**: `GET /api/faculties`
-   **Описание**: Возвращает список всех факультетов.
-   **Аутентификация**: Требуется.
-   **Тело запроса**: Нет.
-   **Успешный ответ (200 OK)**:
    ```json
    {
      "faculties": [
        { "id": 1, "code": "ФИТ", "name": "Факультет информационных технологий", "comments": null },
        { "id": 2, "code": "РК", "name": "Робототехника и комплексная автоматизация", "comments": "Главный корпус" }
      ]
    }
    ```

### Получение факультета по коду
-   **URL**: `GET /api/faculties/:code`
-   **Описание**: Возвращает один факультет по его уникальному коду.
-   **Аутентификация**: Требуется.
-   **Параметры URL**:
    -   `code` (string): Уникальный код факультета (например, "ФИТ").
-   **Тело запроса**: Нет.
-   **Успешный ответ (200 OK)**:
    ```json
    {
      "faculty": { "id": 1, "code": "ФИТ", "name": "Факультет информационных технологий", "comments": null }
    }
    ```
-   **Ответ в случае ошибки**:
    -   `404 Not Found`: `{ "error": "faculty not found" }`

### Создание нового факультета
-   **URL**: `POST /api/faculties`
-   **Описание**: Создает новый факультет.
-   **Аутентификация**: Требуются права администратора.
-   **Тело запроса**:
    ```json
    {
      "code": "Э",
      "name": "Энергомашиностроение",
      "comments": "Старый корпус"
    }
    ```
-   **Успешный ответ (200 OK)**:
    ```json
    {
      "id": 3,
      "message": "faculty created successfully"
    }
    ```

---

## 5. Эндпоинты для работы с очередями (`/api/queues`)

### Создание новой очереди
-   **URL**: `POST /api/queues`
-   **Описание**: Создает новую очередь.
-   **Аутентификация**: Требуются права администратора.
-   **Тело запроса**:
    ```json
    {
      "title": "Консультация по матанализу",
      "group_name": "ИУ5-51Б",
      "time_add": 3
    }
    ```
-   **Успешный ответ (200 OK)**:
    ```json
    {
      "id": 12,
      "message": "queue created successfully"
    }
    ```

### Получение списка всех очередей
-   **URL**: `GET /api/queues`
-   **Описание**: Возвращает список всех очередей, отсортированных по времени начала.
-   **Аутентификация**: Требуется.
-   **Тело запроса**: Нет.
-   **Успешный ответ (200 OK)**:
    ```json
    {
      "queues": [
        { "id": 1, "title": "Консультация", "available_id": 1, "time_start": "2024-05-21T10:00:00Z", "time_end": "2024-05-21T15:00:00Z" },
        { "id": 2, "title": "Сдача лабы", "available_id": 1, "time_start": "2024-05-22T12:00:00Z", "time_end": "2024-05-22T14:00:00Z" }
      ]
    }
    ```

### Получение информации об одной очереди
-   **URL**: `GET /api/queues/:id`
-   **Описание**: Возвращает детальную информацию о конкретной очереди.
-   **Аутентификация**: Требуется.
-   **Параметры URL**:
    -   `id` (integer): ID очереди.
-   **Тело запроса**: Нет.
-   **Успешный ответ (200 OK)**:
    ```json
    {
      "queue": { "id": 1, "title": "Консультация", "available_id": 1, "time_start": "2024-05-21T10:00:00Z", "time_end": "2024-05-21T15:00:00Z" }
    }
    ```

### Обновление очереди
-   **URL**: `PUT /api/queues/:id`
-   **Описание**: Обновляет информацию о существующей очереди.
-   **Аутентификация**: Требуются права администратора.
-   **Параметры URL**:
    -   `id` (integer): ID очереди.
-   **Тело запроса**: (Полный или частичный объект `Queue`)
    ```json
    {
      "title": "Новое название консультации",
      "time_end": "2024-05-21T16:00:00Z"
    }
    ```
-   **Успешный ответ (200 OK)**:
    ```json
    { "message": "queue updated successfully" }
    ```

### Удаление очереди
-   **URL**: `DELETE /api/queues/:id`
-   **Описание**: Удаляет очередь и всех ее участников.
-   **Аутентификация**: Требуются права администратора.
-   **Параметры URL**:
    -   `id` (integer): ID очереди.
-   **Тело запроса**: Нет.
-   **Успешный ответ (200 OK)**:
    ```json
    { "message": "queue deleted successfully" }
    ```

### Присоединиться к очереди
-   **URL**: `POST /api/queues/:id/join`
-   **Описание**: Добавляет текущего пользователя в очередь.
-   **Аутентификация**: Требуется.
-   **Параметры URL**:
    -   `id` (integer): ID очереди (в данной реализации не используется, но присутствует в URL).
-   **Тело запроса**:
    ```json
    {
      "queue_id": 12
    }
    ```
-   **Успешный ответ (200 OK)**:
    ```json
    {
      "participant_id": 150,
      "message": "joined queue successfully"
    }
    ```
-   **Ответ в случае ошибки**:
    -   `400 Bad Request`: `{ "error": "user is already in queue" }`

### Покинуть очередь
-   **URL**: `DELETE /api/queues/:id/leave`
-   **Описание**: Удаляет текущего пользователя из очереди.
-   **Аутентификация**: Требуется.
-   **Параметры URL**:
    -   `id` (integer): ID очереди.
-   **Тело запроса**: Нет.
-   **Успешный ответ (200 OK)**:
    ```json
    { "message": "left queue successfully" }
    ```
-   **Ответ в случае ошибки**:
    -   `400 Bad Request`: `{ "error": "user not found in queue" }`

### Получить участников очереди
-   **URL**: `GET /api/queues/:id/participants`
-   **Описание**: Возвращает список всех активных участников очереди.
-   **Аутентификация**: Требуется.
-   **Параметры URL**:
    -   `id` (integer): ID очереди.
-   **Тело запроса**: Нет.
-   **Успешный ответ (200 OK)**:
    ```json
    {
      "participants": [
        { "id": 150, "queue_id": 12, "user_id": 1, "position": 1, "joined_at": "2024-05-21T10:05:00Z", "is_active": true },
        { "id": 151, "queue_id": 12, "user_id": 5, "position": 2, "joined_at": "2024-05-21T10:15:00Z", "is_active": true }
      ]
    }
    ```

### Сдвинуть очередь
-   **URL**: `POST /api/queues/:id/shift`
-   **Описание**: Удаляет первого участника из очереди и сдвигает позиции всех остальных.
-   **Аутентификация**: Требуются права администратора.
-   **Параметры URL**:
    -   `id` (integer): ID очереди.
-   **Тело запроса**: Нет.
-   **Успешный ответ (200 OK)**:
    ```json
    { "message": "queue shifted successfully" }
    ```
Отлично! Продолжаю и дополняю `README.md`, добавляя разделы, которые описывают технические аспекты проекта, структуру, управление базой данных и общую философию обработки ответов. Это сделает документацию исчерпывающей.

---

## 6. Общая информация об ответах API

### Формат успешных ответов
Успешные ответы всегда сопровождаются HTTP-кодом состояния `2xx` (например, `200 OK` или `201 Created`). Тело ответа содержит данные в формате JSON.

-   Для запросов на получение данных (GET), тело содержит запрошенный объект или массив объектов.
    ```json
    {
      "user": { "id": 1, ... }
    }
    ```
-   Для запросов на создание (POST) или изменение (PUT), тело может содержать созданный объект, его ID или просто сообщение об успехе.
    ```json
    {
      "id": 123,
      "message": "resource created successfully"
    }
    ```

### Формат ответов с ошибками
Все ошибки возвращаются с HTTP-кодом состояния `4xx` или `5xx` и имеют одинаковую JSON-структуру в теле ответа:
```json
{
  "error": "Текстовое описание проблемы"
}
```
Это позволяет фронтенду единообразно обрабатывать любые ошибки, просто извлекая и отображая значение поля `error`.

### Основные HTTP-коды ошибок и их значения:
-   `400 Bad Request`: Запрос составлен некорректно. Это может быть связано с отсутствием обязательных полей в теле запроса, неверным форматом данных или другой логической ошибкой в запросе.
    -   *Пример: Отправка формы регистрации без поля `password`.*
-   `401 Unauthorized`: Ошибка аутентификации. Либо не был предоставлен заголовок `Authorization`, либо переданный JWT-токен недействителен (просрочен, имеет неверную подпись).
    -   *Пример: Попытка доступа к `/api/profile` с неверным токеном.*
-   `403 Forbidden`: Доступ запрещен. Пользователь успешно аутентифицирован, но у него нет прав на выполнение запрошенного действия.
    -   *Пример: Обычный пользователь пытается удалить другого пользователя через `DELETE /api/admin/users/:id`.*
-   `404 Not Found`: Запрошенный ресурс не найден на сервере.
    -   *Пример: Запрос `GET /api/queues/999`, где очереди с ID 999 не существует.*
-   `500 Internal Server Error`: Внутренняя ошибка сервера. Проблема на стороне бэкенда, не зависящая от клиента. Это может быть ошибка базы данных, паника в коде и т.д.

---

## 7. Технологический стек

-   **Язык**: Go (v1.24)
-   **Веб-фреймворк**: Gin Gonic
-   **База данных**: PostgreSQL
-   **Взаимодействие с БД**: `sqlx` для удобной работы с SQL
-   **Конфигурация**: `viper` для чтения `.yml` файлов
-   **Контейнеризация**: Docker, Docker Compose
-   **Миграции БД**: `migrate/migrate`

---

## 8. Структура проекта

Проект имеет следующую структуру, основанную на лучших практиках Go:

```
.
├── cmd/main.go            # Точка входа в приложение
├── configs/               # Файлы конфигурации (config.yml)
├── migrations/            # SQL-файлы миграций базы данных
├── models/                # Структуры Go, описывающие модели данных (User, Queue и т.д.)
├── pkg/                   # Основная логика приложения
│   ├── config/            # Логика загрузки конфигурации
│   ├── handler/           # Обработчики HTTP-запросов (контроллеры)
│   ├── repository/        # Слой для взаимодействия с базой данных
│   └── services/          # Слой бизнес-логики
├── go.mod                 # Управление зависимостями
├── Dockerfile             # Инструкции для сборки Docker-образа приложения
└── docker-compose.yml     # Оркестрация сервисов (приложение, БД, мигратор)
```

---

## 9. Миграции базы данных

Для управления версиями схемы базы данных используется инструмент `migrate/migrate`.

-   **Расположение**: Файлы миграций находятся в папке `/migrations`. Каждый файл имеет `up` (применение миграции) и `down` (откат миграции) версию.
-   **Автоматическое применение**: При запуске через `docker-compose up`, сервис `migrator` автоматически применяет все новые миграции к базе данных `db`. Это гарантирует, что схема БД всегда актуальна.

### Создание новой миграции
Если вам нужно внести изменения в схему БД, создайте новый файл миграции. Это можно сделать с помощью CLI-инструмента `migrate` (требуется его локальная установка).

```bash
# Пример команды для создания новой миграции
migrate create -ext sql -dir migrations -seq add_user_role
```
Эта команда создаст два файла в папке `/migrations`:
-   `000002_add_user_role.up.sql`
-   `000002_add_user_role.down.sql`

Внесите необходимые SQL-изменения в эти файлы. При следующем запуске `docker-compose up --build` они будут применены автоматически.
